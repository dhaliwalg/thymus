# Thymus Default Rules Library
# Claude references this during /thymus:baseline to supplement invariant-detector output.
# Rules are organized by category. Claude selects relevant sections based on detected framework.

version: "1.0"

generic:
  # v2: structure type not yet enforced at runtime
  # - id: generic-no-circular-deps
  #   type: structure
  #   severity: error
  #   description: "No circular module dependencies"

  - id: generic-test-colocation
    type: convention
    severity: warning
    description: "Tests must be colocated with source files"
    rule: "For every src/**/*.ts, there should be a src/**/*.test.ts"

  # v2: structure type not yet enforced at runtime
  # - id: generic-single-responsibility-dirs
  #   type: structure
  #   severity: info
  #   description: "Each directory should have a single clear responsibility"
  #   rule: "Directories should not mix concerns (e.g. no routes + services in same dir)"

  # v2: structure type not yet enforced at runtime
  # - id: generic-no-deep-nesting
  #   type: structure
  #   severity: info
  #   description: "Source files should not be nested more than 4 levels deep"
  #   rule: "No src file should be at depth > 4 from project root"

nextjs:
  - id: nextjs-no-db-in-pages
    type: boundary
    severity: error
    description: "Next.js pages must not import directly from the database layer"
    source_glob: "pages/**"
    forbidden_imports: ["prisma", "src/db/**", "mongoose", "sequelize"]
    reasoning: "Database access in pages bypasses the API layer and breaks SSR safety"

  - id: nextjs-no-db-in-app
    type: boundary
    severity: error
    description: "Next.js app routes must not import directly from the database layer"
    source_glob: "app/**"
    forbidden_imports: ["prisma", "src/db/**", "mongoose", "sequelize"]

  # v2: structure type not yet enforced at runtime
  # - id: nextjs-api-routes-only-in-pages-api
  #   type: structure
  #   severity: warning
  #   description: "API route handlers belong in pages/api or app/api only"
  #   rule: "Files matching the Next.js route handler pattern should live under pages/api/** or app/api/**"

  - id: nextjs-no-server-imports-in-client-ts
    type: boundary
    severity: error
    description: "Client components (.client.ts) must not import server-only modules"
    source_glob: "**/*.client.ts"
    forbidden_imports: ["server-only", "fs", "path", "child_process"]

  - id: nextjs-no-server-imports-in-client-tsx
    type: boundary
    severity: error
    description: "Client components (.client.tsx) must not import server-only modules"
    source_glob: "**/*.client.tsx"
    forbidden_imports: ["server-only", "fs", "path", "child_process"]

express:
  - id: express-middleware-in-middleware-dir
    type: convention
    severity: warning
    description: "Express middleware must live in the middleware/ directory"
    rule: "Files exporting Express middleware functions should be in src/middleware/**"

  - id: express-routes-no-business-logic
    type: boundary
    severity: warning
    description: "Route handlers should delegate to controllers, not contain business logic"
    source_glob: "src/routes/**"
    forbidden_imports: ["src/db/**", "src/repositories/**"]
    allowed_imports: ["src/controllers/**", "src/middleware/**"]

  - id: express-centralized-error-handler
    type: convention
    severity: info
    description: "Error handling should be centralized, not in individual route handlers"
    rule: "try/catch blocks in route handlers should call next(err), not respond directly"

django:
  - id: django-orm-not-in-views
    type: pattern
    severity: error
    description: "Django ORM queries belong in models or managers, not in views"
    scope_glob: "**/views/**"
    forbidden_pattern: "(objects\\.filter|objects\\.get|objects\\.create|objects\\.all)"

  - id: django-orm-not-in-views-py
    type: pattern
    severity: error
    description: "Django ORM queries belong in models or managers, not in views.py"
    scope_glob: "**/views.py"
    forbidden_pattern: "(objects\\.filter|objects\\.get|objects\\.create|objects\\.all)"

  - id: django-business-logic-in-services
    type: convention
    severity: warning
    description: "Business logic should live in service classes, not views"
    rule: "Complex logic in views should be extracted to services/ or managers/"

fastapi:
  - id: fastapi-dependency-injection
    type: convention
    severity: info
    description: "FastAPI route dependencies should use Depends() injection"
    rule: "Routes should accept dependencies via Depends() rather than instantiating them directly"

  # v2: structure type not yet enforced at runtime
  # - id: fastapi-schemas-in-schemas-module
  #   type: structure
  #   severity: warning
  #   description: "Pydantic request/response schemas should be in a dedicated schemas module"
  #   rule: "Classes inheriting from BaseModel should live in schemas/ or models/"

java:
  - id: java-test-colocation
    type: convention
    severity: warning
    description: "Java source classes should have corresponding test classes"
    rule: "For every src/main/java/**/*.java, there should be a src/test/java/**/*Test.java"

  - id: java-no-wildcard-imports
    type: pattern
    severity: warning
    description: "Wildcard imports reduce readability and can cause name collisions"
    scope_glob: "**/*.java"
    forbidden_pattern: "^import\\s+[\\w.]+\\.\\*;"

spring-boot:
  - id: springboot-controller-no-repository
    type: boundary
    severity: error
    description: "Controllers must not import repositories directly"
    source_glob: "**/controller/*.java"
    forbidden_imports:
      - "**/repository/**"
      - "**/dao/**"
    reasoning: "Controllers should delegate to services, not access the data layer directly"

  - id: springboot-model-no-service
    type: boundary
    severity: error
    description: "Models and entities must not import services"
    source_glob: "**/model/*.java"
    forbidden_imports:
      - "**/service/**"
    reasoning: "Models are data carriers — they should not depend on business logic"

  - id: springboot-entity-no-service
    type: boundary
    severity: error
    description: "Entities must not import services"
    source_glob: "**/entity/*.java"
    forbidden_imports:
      - "**/service/**"

  - id: springboot-no-autowired-field-injection
    type: pattern
    severity: warning
    description: "Prefer constructor injection over @Autowired field injection"
    scope_glob: "**/*.java"
    forbidden_pattern: "@Autowired\\s+(private|protected|public)"

spring-mvc:
  - id: springmvc-controller-no-repository
    type: boundary
    severity: error
    description: "Controllers must not import repositories directly"
    source_glob: "**/controller/*.java"
    forbidden_imports:
      - "**/repository/**"
      - "**/dao/**"
    reasoning: "Controllers should delegate to services, not access the data layer directly"

  - id: springmvc-model-no-service
    type: boundary
    severity: error
    description: "Models must not import services"
    source_glob: "**/model/*.java"
    forbidden_imports:
      - "**/service/**"

go:
  - id: go-test-colocation
    type: convention
    severity: warning
    description: "Go source files should have corresponding test files"
    rule: "For every **/*.go (excluding *_test.go), there should be a **/*_test.go in the same package"

  - id: go-handler-no-direct-db
    type: boundary
    severity: error
    description: "HTTP handlers must not import database packages directly"
    source_glob: "**/handler/**/*.go"
    forbidden_imports:
      - "database/sql"
      - "github.com/jackc/pgx/**"
      - "github.com/go-sql-driver/mysql"
      - "gorm.io/gorm"
      - "github.com/jmoiron/sqlx"
    reasoning: "Handlers should delegate to service or repository layers"

  - id: go-handler-no-direct-db-handlers
    type: boundary
    severity: error
    description: "HTTP handlers must not import database packages directly"
    source_glob: "**/handlers/**/*.go"
    forbidden_imports:
      - "database/sql"
      - "github.com/jackc/pgx/**"
      - "github.com/go-sql-driver/mysql"
      - "gorm.io/gorm"
      - "github.com/jmoiron/sqlx"

  - id: go-no-init-functions
    type: pattern
    severity: warning
    description: "Avoid init() functions — they create implicit initialization order dependencies"
    scope_glob: "**/*.go"
    forbidden_pattern: "^func init\\(\\)"
    scope_glob_exclude:
      - "**/main.go"
      - "**/*_test.go"

  - id: go-no-dot-imports
    type: pattern
    severity: warning
    description: "Dot imports pollute the namespace and reduce readability"
    scope_glob: "**/*.go"
    forbidden_pattern: "import\\s+\\."

rust:
  - id: rust-test-colocation
    type: convention
    severity: warning
    description: "Rust source files should have corresponding test modules or test files"
    rule: "For every src/**/*.rs (excluding test files), there should be tests"

  - id: rust-handler-no-direct-db
    type: boundary
    severity: error
    description: "HTTP handlers must not import database crates directly"
    source_glob: "**/handler/**/*.rs"
    forbidden_imports:
      - "diesel"
      - "sqlx"
      - "sea_orm"
      - "tokio_postgres"
    reasoning: "Handlers should delegate to service or repository layers"

  - id: rust-handler-no-direct-db-handlers
    type: boundary
    severity: error
    description: "HTTP handlers must not import database crates directly"
    source_glob: "**/handlers/**/*.rs"
    forbidden_imports:
      - "diesel"
      - "sqlx"
      - "sea_orm"
      - "tokio_postgres"

  - id: rust-no-unwrap-in-lib
    type: pattern
    severity: warning
    description: "Avoid .unwrap() in library code — use proper error handling"
    scope_glob: "src/**/*.rs"
    forbidden_pattern: "\\.unwrap\\(\\)"
    scope_glob_exclude:
      - "src/main.rs"
      - "**/*test*"
      - "**/tests/**"

  - id: rust-no-unsafe-outside-ffi
    type: pattern
    severity: warning
    description: "Restrict unsafe blocks to FFI modules"
    scope_glob: "src/**/*.rs"
    forbidden_pattern: "unsafe\\s*\\{"
    scope_glob_exclude:
      - "**/ffi/**"
      - "**/bindings/**"
      - "**/sys/**"
